<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lessons Learned - Excel Sheet</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel CDN for JSX transpilation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS (xlsx) CDN for Excel import/export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --white: #ffffff;
      --neutral--50-501: #f4f5f6;
      --primary--main: #1f6a4a;
      --primary--surface: #e4ede9;
      --primary--focus: #d7e4de;
      --primary--border: #b7cfc3;
      --primary--hover: #2e9e6e;
      --primary--pressed: #103525;
      --secondary--main: #b26a00;
      --secondary--surface: #f2f6f4;
      --secondary--focus: #e4ede9;
      --secondary--border: #d7e4de;
      --secondary--hover: #e58400;
      --secondary--pressed: #aa6910;
      --error--main: #c1121f;
      --error--bg: #fbeaec;
      --success--main: #198754;
      --success--bg: #e6f4ea;
      --warning--main: #b26a00;
      --warning--bg: #fff4e5;
      --info--main: #2563eb;
      --info--bg: #e7f0fa;
      --text--main: #103525;
      --text--secondary: #444;
      --focus-outline: #1f6a4a;
    }
    @font-face {
      font-family: 'Euclid Circular B';
      src: url('./font/Euclid Circular B Light.ttf') format('truetype');
      font-weight: 300;
      font-style: normal;
    }
    @font-face {
      font-family: 'Euclid Circular B';
      src: url('./font/Euclid Circular B Regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
    }
    @font-face {
      font-family: 'Euclid Circular B';
      src: url('./font/Euclid Circular B Medium.ttf') format('truetype');
      font-weight: 500;
      font-style: normal;
    }
    @font-face {
      font-family: 'Euclid Circular B';
      src: url('./font/Euclid Circular B SemiBold.ttf') format('truetype');
      font-weight: 600;
      font-style: normal;
    }
    @font-face {
      font-family: 'Euclid Circular B';
      src: url('./font/Euclid Circular B Bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
    }
    body {
      background: #fff;
      color: var(--text--main);
      font-family: 'Euclid Circular B', Arial, sans-serif;
      margin: 0;
    }
    .main-container {
      max-width: 1100px;
      margin: 40px auto;
      background: var(--white);
      border-radius: 16px;
      box-shadow: 0 4px 32px rgba(31, 106, 74, 0.10);
      padding: 32px 40px;
    }
    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
    }
    .header-bar h1 {
      font-size: 2.2rem;
      color: var(--primary--main);
      font-weight: 800;
      margin: 0;
    }
    .action-buttons {
      display: flex;
      gap: 16px;
    }
    .btn {
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      padding: 10px 22px;
      box-shadow: 0 2px 8px rgba(31, 106, 74, 0.08);
      border: none;
      cursor: pointer;
      transition: background 0.18s, box-shadow 0.18s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn:focus-visible {
      outline: 2px solid var(--focus-outline);
      outline-offset: 2px;
    }
    .btn-primary { background: var(--primary--main); color: var(--white); }
    .btn-primary:hover, .btn-primary:focus-visible { background: var(--primary--hover); }
    .btn-secondary { background: var(--secondary--main); color: var(--white); }
    .btn-secondary:hover, .btn-secondary:focus-visible { background: var(--secondary--hover); }
    .btn-neutral { background: var(--primary--focus); color: var(--primary--pressed); }
    .btn-dashboard { background: #a084e8; color: var(--white); }
    .btn-import {
      background: var(--info--main);
      color: var(--white);
    }
    .btn-import:hover, .btn-import:focus-visible {
      background: #174fc2;
    }
    .btn-reset {
      background: var(--warning--bg);
      color: var(--warning--main);
      border: 1.5px solid var(--warning--main);
    }
    .btn-reset:hover, .btn-reset:focus-visible {
      background: #ffe1b3;
      color: #aa6910;
    }
    .filter-card {
      background: var(--primary--surface);
      border-radius: 12px;
      box-shadow: 0 1px 6px rgba(31, 106, 74, 0.06);
      padding: 24px;
      margin-bottom: 32px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: center;
    }
    .filter-card input[type="text"], .filter-card select {
      border-radius: 6px;
      border: 1.5px solid var(--primary--border);
      padding: 10px 14px;
      font-size: 1rem;
      background: var(--white);
      color: var(--text--main);
      transition: border 0.15s;
    }
    .filter-card input[type="text"]:focus, .filter-card select:focus {
      border-color: var(--primary--main);
      outline: 2px solid var(--primary--main);
    }
    .clear-filter-btn {
      background: #fff;
      color: #1f6a4a;
      border: 1.5px solid #1f6a4a;
      border-radius: 6px;
      padding: 10px 18px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, color 0.15s, border 0.15s;
      margin-left: 8px;
    }
    .clear-filter-btn:hover, .clear-filter-btn:focus-visible {
      background: #e4ede9;
      color: #256c3a;
      border-color: #256c3a;
    }
    .table {
      width: 100% !important;
      border-collapse: separate !important;
      border-spacing: 0 !important;
      background: #1f6a4a !important;
      border-radius: 12px !important;
      overflow: hidden !important;
      font-family: 'Euclid Circular B', Arial, sans-serif !important;
    }
    .table th, .table td {
      padding: 16px 18px !important;
      text-align: left !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
    }
    .table th {
      background: #1f6a4a !important;
      color: #fff !important;
      font-size: 1.1rem !important;
      font-weight: 700 !important;
      border-bottom: 2px solid #17603a !important;
    }
    .table tr {
      background: #1f6a4a !important;
      color: #fff !important;
      transition: background 0.15s !important;
    }
    .table tr:nth-child(even) {
      background: #237a56 !important;
    }
    .table tr:hover {
      background: #2e9e6e !important;
    }
    .table td {
      border-bottom: 1px solid #17603a !important;
      color: #fff !important;
      font-size: 1rem !important;
      max-width: 220px !important;
    }
    .table th:first-child, .table td:first-child {
      border-top-left-radius: 12px !important;
    }
    .table th:last-child, .table td:last-child {
      border-top-right-radius: 12px !important;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 20px;
      border-radius: 12px;
      font-size: 0.95em;
      font-weight: 700;
      white-space: nowrap;
      min-width: 110px;
      text-align: center;
    }
    .status-not-started {
      background: #ffeaea;
      color: #c1121f;
    }
    .status-in-progress { background: #ffe066; color: #b26a00; }
    .status-completed { background: #2e9e6e; color: #fff; }
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      background: transparent;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: var(--primary--border);
      border-radius: 3px;
    }
    .card {
      background: var(--secondary--surface);
      border: 1px solid var(--primary--border);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(31, 106, 74, 0.04);
      padding: 24px;
      margin-bottom: 24px;
    }
    .input, select, textarea {
      border: 1.5px solid #b7cfc3;
      border-radius: 8px;
      padding: 12px 14px;
      font-size: 1rem;
      background: #fff;
      color: #103525;
      transition: border 0.15s, box-shadow 0.15s;
    }
    .input:focus, select:focus, textarea:focus {
      border-color: #1f6a4a;
      box-shadow: 0 0 0 2px #e4ede9;
      outline: none;
    }
    .input[aria-invalid="true"], select[aria-invalid="true"] {
      border-color: #c1121f;
      background: #ffeaea;
    }
    .input[readonly], .input[disabled], select[readonly], select[disabled], textarea[readonly], textarea[disabled] {
      background: #f2f6f4;
      color: #b7cfc3;
    }
    .label {
      font-weight: 500;
      margin-bottom: 4px;
      display: block;
      color: var(--text--main);
    }
    .alert {
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-weight: 500;
    }
    .alert-success {
      background: var(--success--bg);
      color: var(--success--main);
      border: 1px solid var(--success--main);
    }
    .alert-error {
      background: var(--error--bg);
      color: var(--error--main);
      border: 1px solid var(--error--main);
    }
    .alert-warning {
      background: var(--warning--bg);
      color: var(--warning--main);
      border: 1px solid var(--warning--main);
    }
    .modal-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(44, 62, 80, 0.18);
      padding: 2.5rem 2.5rem 2rem 2.5rem;
      min-width: 480px;
      max-width: 96vw;
      width: 540px;
      margin: 0 auto;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      max-height: 90vh;
      overflow-y: auto;
    }
    @media (max-width: 600px) {
      .modal-card {
        min-width: 0;
        width: 98vw;
        padding: 1.2rem 0.5rem 1.2rem 0.5rem;
      }
    }
    .modal-card h2 {
      font-size: 1.4rem;
      font-weight: 800;
      color: #1f6a4a;
      margin-bottom: 24px;
    }
    .modal-close {
      position: absolute;
      top: 18px;
      right: 22px;
      font-size: 2rem;
      color: #b7cfc3;
      background: none;
      border: none;
      cursor: pointer;
      transition: color 0.15s;
    }
    .modal-close:hover { color: #c1121f; }
    .form-group {
      margin-bottom: 18px;
      display: flex;
      flex-direction: column;
    }
    .form-label {
      font-weight: 700;
      color: #103525;
      margin-bottom: 6px;
      font-size: 1.05rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .form-label .required {
      color: #c1121f;
      font-size: 1.1em;
      margin-left: 2px;
    }
    .error-message {
      color: #c1121f;
      font-size: 0.95em;
      margin-top: 4px;
    }
    .button-row {
      display: flex;
      justify-content: flex-end;
      gap: 16px;
      margin-top: 24px;
    }
    .btn-modal-save {
      background: #1f6a4a;
      color: #fff;
      font-weight: 700;
      border-radius: 8px;
      padding: 10px 28px;
      border: none;
      font-size: 1.05rem;
      box-shadow: 0 2px 8px rgba(31, 106, 74, 0.08);
      cursor: pointer;
      transition: background 0.15s;
    }
    .btn-modal-save:hover, .btn-modal-save:focus-visible {
      background: #2e9e6e;
    }
    .btn-modal-cancel {
      background: #e4ede9;
      color: #103525;
      border-radius: 8px;
      padding: 10px 22px;
      border: none;
      font-size: 1.05rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.15s;
    }
    .btn-modal-cancel:hover, .btn-modal-cancel:focus-visible {
      background: #b7cfc3;
    }
    .action-icons {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .action-icon-btn {
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: background 0.15s;
    }
    .action-icon-btn:focus-visible {
      outline: 2px solid #1f6a4a;
      background: #e4ede9;
    }
    .action-icon-edit svg,
    .action-icon-delete svg,
    .action-icon-duplicate svg {
      color: #fff;
    }
    .action-icon-btn:hover svg,
    .action-icon-btn:focus-visible svg {
      filter: none;
      color: #fff;
    }
    .modal-input {
      width: 100%;
      border: 1.5px solid #b7cfc3;
      border-radius: 7px;
      background: #fff;
      font-size: 1rem;
      color: #234c36;
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
      transition: border 0.15s;
      box-sizing: border-box;
      padding: 0.75rem 1rem;
      min-height: 40px;
    }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(44, 62, 80, 0.18);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-close {
      position: absolute;
      top: 1.2rem;
      right: 1.2rem;
      background: none;
      border: none;
      font-size: 2rem;
      color: #234c36;
      cursor: pointer;
      z-index: 10;
    }
    /* Add/Update styles for the view details modal */
    .view-modal-card {
      background: #e4ede9;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(44, 62, 80, 0.18);
      padding: 2.5rem 2.5rem 2rem 2.5rem;
      min-width: 480px;
      max-width: 96vw;
      width: 540px;
      margin: 0 auto;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      max-height: 90vh;
      overflow-y: auto;
      border: 2.5px solid #1f6a4a;
    }
    .view-modal-title {
      color: #fff;
      background: #1f6a4a;
      border-radius: 12px 12px 0 0;
      padding: 1rem 1.5rem;
      margin: -2.5rem -2.5rem 1.5rem -2.5rem;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    .view-modal-label {
      color: #1f6a4a;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .view-modal-value {
      background: #f6faf8;
      border-radius: 7px;
      padding: 0.75rem 1rem;
      color: #234c36;
      white-space: pre-line;
    }
    .view-modal-close {
      position: absolute;
      top: 1.2rem;
      right: 1.2rem;
      background: none;
      border: none;
      font-size: 2rem;
      color: #1f6a4a;
      cursor: pointer;
      z-index: 10;
      transition: color 0.15s;
    }
    .view-modal-close:hover {
      color: #256c3a;
    }
    /* User Guide Card Grid Styles */
    .user-guide-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
      margin: 2.5rem 0 2rem 0;
    }
    .user-guide-card {
      padding: 16px;
      border-radius: 8px;
      font-size: 1.08rem;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(44, 62, 80, 0.06);
      outline: none;
      transition: box-shadow 0.15s, border 0.15s;
    }
    .user-guide-card:focus {
      box-shadow: 0 0 0 3px #1f6a4a;
      border: 1.5px solid #1f6a4a;
    }
    .user-guide-card.dark {
      background: #1f6a4a;
      color: #fff;
    }
    .user-guide-card.light {
      background: #e8f0ec;
      color: #1c2526;
    }
    @media (max-width: 600px) {
      .user-guide-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
    }
    /* Add Impact Level badge styles */
    .impact-badge {
      display: inline-block;
      padding: 4px 20px;
      border-radius: 12px;
      font-size: 0.95em;
      font-weight: 700;
      white-space: nowrap;
      min-width: 90px;
      text-align: center;
    }
    .impact-low {
      background: #2e9e6e;
      color: #fff;
    }
    .impact-medium {
      background: #ffe066;
      color: #7a5c00 !important;
    }
    .impact-high {
      background: #ffeaea;
      color: #c1121f;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
  <div id="root"></div>
  <script type="text/babel">
    // --- Demo Data (mimics Excel structure) ---
    const DEMO_DATA = [
      {
        Customer: "Acme Corp",
        Platform: "Web",
        Issue: "Login fails intermittently",
        "Detailed Description": "Users report random login failures during peak hours.",
        "Impact Level": "High",
        "Liable Stakeholder": "Backend Team",
        "Preventive Action": "Improve session handling, add monitoring",
        "Lessons Learned": "Need better load testing before releases.",
        Status: "Open",
        Timeline: "2024-05-01",
        Tags: ["Backend", "Auth"]
      },
      {
        Customer: "Beta Inc",
        Platform: "Mobile",
        Issue: "App crashes on launch",
        "Detailed Description": "Crash on Android 12 devices after update.",
        "Impact Level": "Medium",
        "Liable Stakeholder": "Mobile Team",
        "Preventive Action": "Update dependencies, add device tests",
        "Lessons Learned": "Test on all supported OS versions.",
        Status: "In Progress",
        Timeline: "2024-04-15",
        Tags: ["Mobile"]
      },
      {
        Customer: "Acme Corp",
        Platform: "Web",
        Issue: "Slow dashboard load",
        "Detailed Description": "Dashboard takes >10s to load for some users.",
        "Impact Level": "Low",
        "Liable Stakeholder": "Frontend Team",
        "Preventive Action": "Optimize queries, lazy load widgets",
        "Lessons Learned": "Monitor performance post-deploy.",
        Status: "Done",
        Timeline: "2024-03-10",
        Tags: ["UI", "Performance"]
      },
      {
        Customer: "Delta LLC",
        Platform: "API",
        Issue: "Incorrect data in reports",
        "Detailed Description": "API returns outdated data for some endpoints.",
        "Impact Level": "High",
        "Liable Stakeholder": "API Team",
        "Preventive Action": "Add data cache invalidation",
        "Lessons Learned": "Automate data freshness checks.",
        Status: "Fixed",
        Timeline: "2024-02-20",
        Tags: ["API"]
      },
      {
        Customer: "Beta Inc",
        Platform: "Web",
        Issue: "UI misalignment on Safari",
        "Detailed Description": "Buttons overlap on Safari 15.",
        "Impact Level": "Medium",
        "Liable Stakeholder": "Frontend Team",
        "Preventive Action": "Cross-browser CSS tests",
        "Lessons Learned": "Include Safari in CI.",
        Status: "In Testing",
        Timeline: "2024-04-01",
        Tags: ["UI"]
      }
    ];

    // --- Constants ---
    const FIELDS = [
      { key: "Customer", label: "Customer", required: true, autoComplete: true, tooltip: "Client or organization affected." },
      { key: "Platform", label: "Platform", required: true, autoComplete: true, tooltip: "Product platform (Web, Mobile, API, etc.)." },
      { key: "Issue", label: "Issue", required: true, tooltip: "Short summary of the problem." },
      { key: "Detailed Description", label: "Detailed Description", required: true, tooltip: "Full details of the issue." },
      { key: "Impact Level", label: "Impact Level", required: true, type: "select", options: ["Low", "Medium", "High"], tooltip: "Assess severity of the issue." },
      { key: "Liable Stakeholder", label: "Liable Stakeholder", required: false, tooltip: "Team or person responsible." },
      { key: "Preventive Action", label: "Preventive Action", required: false, tooltip: "How to prevent recurrence." },
      { key: "Lessons Learned", label: "Lessons Learned", required: false, tooltip: "Key takeaways from the issue." },
      { key: "Status", label: "Status", required: true, type: "select", options: ["Not Started", "In Progress", "Completed"], tooltip: "Current state of the issue." },
      { key: "Timeline", label: "Timeline", required: false, type: "date", tooltip: "Relevant date (e.g., fix, discovery)." },
    ];
    const STATUS_COLORS = {
      "Not Started": "bg-gray-400 text-white",
      "In Progress": "bg-orange-400 text-white",
      "Completed": "bg-green-500 text-white"
    };
    const STORAGE_KEY = "lessons_learned_data_v1";
    const STORAGE_AUDIT = "lessons_learned_audit_v1";
    const STORAGE_PREF = "lessons_learned_pref_v1";

    // --- Utility Functions ---
    /**
     * Debounce function for performance
     * @param {Function} fn
     * @param {number} delay
     * @returns {Function}
     */
    function debounce(fn, delay) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delay);
      };
    }

    /**
     * Export data to Excel
     * @param {Array} data
     */
    function exportToExcel(data) {
      const header = FIELDS.map(f => f.key);
      const rows = data.map(row => header.map(fieldName => {
        let val = row[fieldName];
        if (Array.isArray(val)) return val.join(';');
        return val == null ? '' : val;
      }));
      const ws = XLSX.utils.aoa_to_sheet([header, ...rows]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Lessons');
      XLSX.writeFile(wb, 'lessons_learned_export.xlsx');
    }

    /**
     * Import data from Excel
     * @param {File} file
     * @param {Function} onSuccess
     * @param {Function} onError
     */
    function importFromExcel(file, onSuccess, onError) {
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
          onSuccess(rows);
        } catch (err) {
          onError('Malformed Excel file. Please check the format.');
        }
      };
      reader.onerror = () => onError('Failed to read file.');
      reader.readAsArrayBuffer(file);
    }

    /**
     * Save data to localStorage/sessionStorage
     */
    function saveData(data, audit) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        if (audit) localStorage.setItem(STORAGE_AUDIT, JSON.stringify(audit));
        return true;
      } catch (e) {
        try {
          sessionStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          if (audit) sessionStorage.setItem(STORAGE_AUDIT, JSON.stringify(audit));
          return false;
        } catch (err) {
          alert('Storage quota exceeded. Data not saved.');
          return false;
        }
      }
    }

    /**
     * Load data from localStorage/sessionStorage
     */
    function loadData() {
      let data = localStorage.getItem(STORAGE_KEY) || sessionStorage.getItem(STORAGE_KEY);
      let audit = localStorage.getItem(STORAGE_AUDIT) || sessionStorage.getItem(STORAGE_AUDIT);
      return {
        data: data ? JSON.parse(data) : null,
        audit: audit ? JSON.parse(audit) : []
      };
    }

    /**
     * Save user preferences (e.g., dark mode)
     */
    function savePref(pref) {
      localStorage.setItem(STORAGE_PREF, JSON.stringify(pref));
    }
    function loadPref() {
      let pref = localStorage.getItem(STORAGE_PREF);
      return pref ? JSON.parse(pref) : {};
    }

    /**
     * Generate a unique ID for rows
     */
    function genId() {
      return '_' + Math.random().toString(36).substr(2, 9);
    }

    /**
     * Format date for display
     */
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      return d.toLocaleDateString();
    }

    // Add normalization functions for status and impact level
    function normalizeStatus(status) {
      if (!status) return '';
      const s = status.trim().toLowerCase();
      if (s === 'not started' || s === 'not started yet') return 'Not Started';
      if (s === 'in progress') return 'In Progress';
      if (s === 'completed') return 'Completed';
      return status;
    }
    function normalizeImpactLevel(level) {
      if (!level) return '';
      const l = level.trim().toLowerCase();
      if (l === 'medium' || l === 'meduim' || l === 'med') return 'Medium';
      if (l === 'low') return 'Low';
      if (l === 'high') return 'High';
      return level;
    }

    // --- React Components ---
    const { useState, useEffect, useRef, useMemo } = React;

    /**
     * User Guide (collapsible)
     */
    function UserGuide() {
      const [open, setOpen] = useState(false);
      return (
        <div className="mb-4">
          <button
            className="text-blue-600 underline focus:outline-none"
            onClick={() => setOpen(o => !o)}
            aria-expanded={open}
            aria-controls="user-guide-content"
          >
            {open ? 'Hide' : 'Show'} User Guide
          </button>
          {open && (
            <div id="user-guide-content" className="mt-2 p-4 bg-blue-50 rounded shadow text-sm">
              <h2 className="font-bold mb-2">How to Use the Lessons Learned App</h2>
              <ul className="list-disc ml-5 space-y-1">
                <li>Add, edit, duplicate, or delete lessons using the table below.</li>
                <li>Required fields are marked with <span className="text-red-500">*</span> and validated in real time.</li>
                <li>Use the filter bar to quickly find lessons by Customer, Platform, Impact Level, or Status.</li>
                <li>Click column headers to sort. Use the search bar for instant keyword filtering.</li>
                <li>Auto-complete is available for Customer and Platform fields.</li>
                <li>Data is auto-saved to your browser. Use Export/Import for backup or Excel integration.</li>
                <li>Toggle the dashboard for charts. Switch between light/dark mode for comfort.</li>
                <li>All actions are accessible via keyboard and screen readers.</li>
              </ul>
            </div>
          )}
        </div>
      );
    }

    /**
     * Status Badge
     */
    function StatusBadge({ status }) {
      const color = STATUS_COLORS[status] || 'bg-gray-300 text-gray-800';
      return <span className={`px-2 py-1 rounded text-xs font-semibold ${color}`}>{status}</span>;
    }

    /**
     * Tooltip
     */
    function Tooltip({ text, children }) {
      const [show, setShow] = useState(false);
      return (
        <span className="relative" onMouseEnter={() => setShow(true)} onMouseLeave={() => setShow(false)}>
          {children}
          {show && (
            <span className="absolute z-10 left-1/2 -translate-x-1/2 mt-2 w-max max-w-xs bg-black text-white text-xs rounded px-2 py-1 shadow-lg">
              {text}
            </span>
          )}
        </span>
      );
    }

    /**
     * Chart.js Dashboard
     */
    function Dashboard({ data, onClose }) {
      const chartRef = useRef();
      const chartInstance = useRef();
      const [mode, setMode] = useState('Impact Level');
      useEffect(() => {
        if (!chartRef.current) return;
        const ctx = chartRef.current.getContext('2d');
        if (chartInstance.current) chartInstance.current.destroy();
        // Prepare data
        const groupBy = mode;
        const counts = {};
        data.forEach(row => {
          let key = row[groupBy] || null;
          if (groupBy === 'Status') key = normalizeStatus(key);
          if (groupBy === 'Impact Level') key = normalizeImpactLevel(key);
          if (key && key !== 'Unknown') {
            counts[key] = (counts[key] || 0) + 1;
          }
        });
        const labels = Object.keys(counts);
        const values = Object.values(counts);
        // Use accessible, color-blind-friendly palette
        const palette = [
          '#1f6a4a', // green
          '#2e9e6e', // lighter green
          '#b26a00', // orange
          '#2563eb', // blue
          '#ffe066', // yellow
          '#c1121f', // red (for error, not for status)
        ];
        const chartColors = labels.map((_, i) => palette[i % palette.length]);
        chartInstance.current = new Chart(ctx, {
          type: 'pie',
          data: {
            labels,
            datasets: [{
              data: values,
              backgroundColor: chartColors,
              borderColor: '#fff',
              borderWidth: 2,
            }]
          },
          options: {
            plugins: {
              legend: {
                labels: {
                  color: '#103525',
                  font: { weight: 'bold', size: 14 },
                  boxWidth: 20,
                  padding: 18
                },
                position: 'top',
                align: 'start',
              },
              title: {
                display: false
              }
            },
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }, [data, mode]);
      return (
        <div className="fixed inset-0 z-50 bg-black bg-opacity-30 flex items-center justify-center">
          <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md relative" style={{ minHeight: 420 }}>
            <button className="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl font-bold" onClick={onClose} aria-label="Close dashboard">
              ×
            </button>
            <h2 className="text-xl font-extrabold mb-4 text-primary--main">Dashboard</h2>
            <div className="flex gap-2 mb-4">
              <button className={`btn btn-neutral ${mode === 'Impact Level' ? 'btn-primary' : ''}`} onClick={() => setMode('Impact Level')}>Impact Level</button>
              <button className={`btn btn-neutral ${mode === 'Status' ? 'btn-primary' : ''}`} onClick={() => setMode('Status')}>Status</button>
            </div>
            <div className="flex flex-col items-center">
              <div className="w-full flex justify-center mb-4">
                <canvas ref={chartRef} aria-label="Lessons Learned Chart" style={{ width: 280, height: 280 }} />
              </div>
            </div>
          </div>
        </div>
      );
    }

    /**
     * Confirmation Modal
     */
    function ConfirmModal({ open, onConfirm, onCancel, message }) {
      if (!open) return null;
      return (
        <div className="fixed inset-0 z-50 bg-black bg-opacity-40 flex items-center justify-center">
          <div className="bg-white rounded-lg shadow-lg p-6 w-full max-w-sm">
            <div className="mb-4 text-lg">{message}</div>
            <div className="flex justify-end gap-2">
              <button className="px-4 py-2 bg-gray-200 rounded" onClick={onCancel}>Cancel</button>
              <button className="px-4 py-2 bg-red-500 text-white rounded" onClick={onConfirm}>Confirm</button>
            </div>
          </div>
        </div>
      );
    }

    /**
     * AutoComplete Input
     */
    function AutoCompleteInput({ value, options, onChange, required }) {
      const [show, setShow] = useState(false);
      const [input, setInput] = useState(value);
      const ref = useRef();
      useEffect(() => { setInput(value); }, [value]);
      const filtered = options.filter(opt => opt.toLowerCase().includes(input.toLowerCase()));
      return (
        <div className="relative">
          <input
            type="text"
            className={`px-2 py-1 border rounded w-full ${required && !input ? 'border-red-500' : ''}`}
            value={input}
            onChange={e => { setInput(e.target.value); onChange(e.target.value); setShow(true); }}
            onFocus={() => setShow(true)}
            onBlur={() => setTimeout(() => setShow(false), 100)}
            required={required}
            autoComplete="off"
          />
          {show && filtered.length > 0 && (
            <div className="absolute z-10 left-0 right-0 bg-white border rounded shadow max-h-32 overflow-y-auto">
              {filtered.map(opt => (
                <div key={opt} className="px-2 py-1 hover:bg-blue-100 cursor-pointer" onMouseDown={() => { onChange(opt); setInput(opt); setShow(false); }}>{opt}</div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // Place this after StatusBadge and before LessonsLearnedApp
    function ImpactBadge({ level }) {
      if (!level) return null;
      const key = (level || '').toLowerCase();
      let cls = 'impact-badge ';
      if (key === 'low') cls += 'impact-low';
      else if (key === 'medium') cls += 'impact-medium';
      else if (key === 'high') cls += 'impact-high';
      else cls += 'impact-low';
      return <span className={cls}>{level}</span>;
    }

    /**
     * Main Lessons Learned App
     */
    function LessonsLearnedApp() {
      // --- State ---
      const [data, setData] = useState(() => {
        const { data } = loadData();
        return (data || DEMO_DATA).map(row => ({
          ...row,
          _id: row._id || genId(),
          Status: normalizeStatus(row.Status),
          "Impact Level": normalizeImpactLevel(row["Impact Level"])
        }));
      });
      const [filters, setFilters] = useState({});
      const [sort, setSort] = useState({ key: null, dir: 'asc' });
      const [search, setSearch] = useState('');
      const [showDashboard, setShowDashboard] = useState(false);
      const [dark, setDark] = useState(() => {
        const pref = loadPref();
        return pref.dark ?? window.matchMedia('(prefers-color-scheme: dark)').matches;
      });
      const [editingId, setEditingId] = useState(null);
      const [editRow, setEditRow] = useState({});
      const [error, setError] = useState('');
      const [confirm, setConfirm] = useState({ open: false, action: null, message: '' });
      const [importError, setImportError] = useState('');
      const [showGuide, setShowGuide] = useState(false);
      const [quickEdit, setQuickEdit] = useState({ id: null, field: null });
      const [viewLesson, setViewLesson] = useState(null);
      const [showInstructions, setShowInstructions] = useState(false);
      const debouncedSetSearch = useMemo(() => debounce(val => setSearch(val), 300), []);
      // --- Effects ---
      useEffect(() => {
        document.documentElement.classList.toggle('dark', dark);
        savePref({ dark });
      }, [dark]);
      useEffect(() => {
        saveData(data, []);
      }, [data]);
      // --- Derived ---
      const autoCompleteOptions = useMemo(() => {
        const opts = {};
        FIELDS.filter(f => f.autoComplete).forEach(f => {
          opts[f.key] = Array.from(new Set(data.map(row => row[f.key]).filter(Boolean)));
        });
        return opts;
      }, [data]);
      // --- Filtering, Sorting, Searching ---
      const filteredData = useMemo(() => {
        let rows = data;
        Object.entries(filters).forEach(([key, val]) => {
          if (val) rows = rows.filter(row => row[key] === val);
        });
        if (search) {
          const s = search.toLowerCase();
          rows = rows.filter(row => FIELDS.some(f => (row[f.key] || '').toString().toLowerCase().includes(s)));
        }
        if (sort.key) {
          rows = [...rows].sort((a, b) => {
            let av = a[sort.key] || '';
            let bv = b[sort.key] || '';
            if (sort.key === 'Timeline') {
              av = new Date(av);
              bv = new Date(bv);
            }
            if (av < bv) return sort.dir === 'asc' ? -1 : 1;
            if (av > bv) return sort.dir === 'asc' ? 1 : -1;
            return 0;
          });
        }
        return rows;
      }, [data, filters, search, sort]);
      // --- Virtualization ---
      const VIRTUAL_LIMIT = 50;
      const [scrollTop, setScrollTop] = useState(0);
      const tableBodyRef = useRef();
      const rowHeight = 56; // px
      const visibleRows = useMemo(() => {
        if (filteredData.length <= VIRTUAL_LIMIT) return filteredData;
        const start = Math.floor(scrollTop / rowHeight);
        const end = Math.min(filteredData.length, start + VIRTUAL_LIMIT);
        return filteredData.slice(start, end);
      }, [filteredData, scrollTop]);
      // --- Handlers ---
      async function notifyTimelineChange(lesson) {
        try {
          await fetch(fetch('https://lessons-learned-notification.onrender.com/api/notify-timeline-change', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(lesson),
          });
        } catch (err) {
          console.error('Failed to notify timeline change:', err);
        }
      }
      const handleAdd = () => {
        setEditRow({ _id: genId(), ...FIELDS.reduce((acc, f) => { acc[f.key] = f.key === 'Status' ? 'Not Started' : (f.type === 'tags' ? [] : ''); return acc; }, {}) });
        setEditingId(null);
      };
      const handleEdit = (id) => {
        setEditRow({ ...data.find(r => r._id === id) });
        setEditingId(id);
      };
      const handleDelete = (id) => {
        setConfirm({ open: true, action: () => {
          setData(data => data.filter(r => r._id !== id));
        }, message: 'Delete this row? This action cannot be undone.' });
      };
      const handleDuplicate = (id) => {
        const row = data.find(r => r._id === id);
        if (row) {
          const newRow = { ...row, _id: genId() };
          setData(data => [newRow, ...data]);
        }
      };
      const handleSave = () => {
        // Validation
        for (const f of FIELDS) {
          if (f.required && !editRow[f.key]) {
            setError(`${f.label} is required.`);
            return;
          }
        }
        setError('');
        const normalizedRow = {
          ...editRow,
          Status: normalizeStatus(editRow.Status),
          "Impact Level": normalizeImpactLevel(editRow["Impact Level"])
        };
        if (editingId) {
          const oldLesson = data.find(r => r._id === editingId);
          const timelineChanged = oldLesson && oldLesson.Timeline !== normalizedRow.Timeline;
          setData(data => data.map(r => r._id === editingId ? { ...normalizedRow } : r));
          if (timelineChanged) {
            notifyTimelineChange(normalizedRow);
          }
        } else {
          setData(data => [{ ...normalizedRow }, ...data]);
        }
        setEditRow({});
        setEditingId(null);
      };
      const handleCancel = () => {
        setEditRow({});
        setEditingId(null);
        setError('');
      };
      const handleImport = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        importFromExcel(file, (rows) => {
          // Assign _id to each row and normalize status and impact level
          const newRows = rows.map(row => ({
            ...row,
            _id: genId(),
            Status: row.Status && row.Status.trim() ? normalizeStatus(row.Status) : 'Not Started',
            "Impact Level": normalizeImpactLevel(row["Impact Level"])
          }));
          setData(newRows);
          setImportError('');
        }, (err) => setImportError(err));
      };
      const handleExport = () => {
        exportToExcel(data);
      };
      const handleReset = () => {
        setConfirm({ open: true, action: () => {
          setData([]);
        }, message: 'Delete all data? This action cannot be undone.' });
      };
      const handleQuickEdit = (id, field) => {
        setQuickEdit({ id, field });
      };
      const handleQuickEditSave = (id, field, value) => {
        setData(data => data.map(r => r._id === id ? { ...r, [field]: value } : r));
        setQuickEdit({ id: null, field: null });
      };
      const handleViewLesson = (row) => {
        setViewLesson(row);
      };
      const closeViewLesson = () => {
        setViewLesson(null);
      };
      const toggleInstructions = () => {
        setShowInstructions(v => !v);
      };
      // --- Render ---
      return (
        <div className="main-container">
          <div className="header-bar">
            <h1>Lessons Learned</h1>
            <div className="action-buttons">
              <button className="btn btn-primary" onClick={handleAdd}>Add Lesson</button>
              <button className="btn btn-secondary" onClick={handleExport}>Export Excel</button>
              <label className="btn btn-import cursor-pointer">
                Import Excel
                <input type="file" accept=".xlsx" className="hidden" onChange={handleImport} />
              </label>
              <button className="btn btn-reset" onClick={handleReset}>Reset Form</button>
              <button className="btn btn-dashboard" onClick={() => setShowDashboard(true)}>Dashboard</button>
            </div>
          </div>
          <div style={{marginTop: '2.5rem', marginBottom: '2rem'}}>
            <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
              <h2 id="user-instructions" style={{fontSize: '1.5rem', fontWeight: 700, color: '#1f6a4a', marginBottom: '1.2rem', letterSpacing: '0.01em', marginBottom: 0}}>
                User Instructions
              </h2>
              <button
                onClick={toggleInstructions}
                aria-expanded={showInstructions}
                aria-controls="user-guide-cards"
                aria-label={showInstructions ? 'Hide User Instructions' : 'Show User Instructions'}
                style={{
                  background: '#e8f0ec',
                  border: 'none',
                  borderRadius: '6px',
                  padding: '6px 12px',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  fontWeight: 600,
                  color: '#1f6a4a',
                  fontSize: '1rem',
                  marginLeft: '0.5rem',
                  outline: 'none',
                  boxShadow: '0 1px 4px rgba(44,62,80,0.07)'
                }}
                onKeyDown={e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleInstructions(); } }}
              >
                {showInstructions ? 'Hide' : 'Show'}
                <span aria-hidden="true" style={{marginLeft: '0.5em', display: 'inline-block', transition: 'transform 0.2s', transform: showInstructions ? 'rotate(180deg)' : 'rotate(0deg)'}}>
                  <svg width="18" height="18" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="#1f6a4a" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>
                </span>
              </button>
            </div>
            {showInstructions && (
              <div className="user-guide-grid" id="user-guide-cards" aria-label="Lessons Learned App User Guide" aria-describedby="user-instructions">
                <div className="user-guide-card dark" tabIndex={0} role="region" aria-label="Add, edit, duplicate, or delete lessons using the table below.">
                  Add, edit, duplicate, or delete lessons using the table below.
                </div>
                <div className="user-guide-card light" tabIndex={0} role="region" aria-label="Required fields are marked with star and validated in real time.">
                  Required fields are marked with * and validated in real time.
                </div>
                <div className="user-guide-card dark" tabIndex={0} role="region" aria-label="Use the filter bar to quickly find lessons by Customer, Platform, Impact Level, or Status.">
                  Use the filter bar to quickly find lessons by Customer, Platform, Impact Level, or Status.
                </div>
                <div className="user-guide-card light" tabIndex={0} role="region" aria-label="Click column headers to sort. Use the search bar for instant keyword filtering.">
                  Click column headers to sort. Use the search bar for instant keyword filtering.
                </div>
                <div className="user-guide-card dark" tabIndex={0} role="region" aria-label="Auto-complete is available for Customer and Platform fields.">
                  Auto-complete is available for Customer and Platform fields.
                </div>
                <div className="user-guide-card light" tabIndex={0} role="region" aria-label="Data is auto-saved to your browser. Use Export/Import for backup or Excel integration.">
                  Data is auto-saved to your browser. Use Export/Import for backup or Excel integration.
                </div>
                <div className="user-guide-card dark" tabIndex={0} role="region" aria-label="Toggle the dashboard for charts.">
                  Toggle the dashboard for charts.
                </div>
                <div className="user-guide-card light" tabIndex={0} role="region" aria-label="All actions are accessible via keyboard and screen readers.">
                  All actions are accessible via keyboard and screen readers.
                </div>
              </div>
            )}
          </div>
          {importError && <div className="mb-2 text-red-600">{importError}</div>}
          <div className="filter-card">
            <input
              type="text"
              className="filter-card input"
              placeholder="Search..."
              value={search}
              onChange={e => debouncedSetSearch(e.target.value)}
              aria-label="Global search"
            />
            {FIELDS.filter(f => ["Customer", "Platform", "Impact Level", "Status"].includes(f.key)).map(f => (
              <select
                key={f.key}
                className="filter-card input"
                value={filters[f.key] || ''}
                onChange={e => setFilters(fl => ({ ...fl, [f.key]: e.target.value }))}
                aria-label={`Filter by ${f.label}`}
              >
                <option value="">All {f.label}</option>
                {Array.from(new Set(data.map(row => row[f.key]).filter(Boolean))).map(opt => (
                  <option key={opt} value={opt}>{opt}</option>
                ))}
              </select>
            ))}
            <button
              className="clear-filter-btn"
              type="button"
              onClick={() => { debouncedSetSearch(''); setFilters({}); }}
              aria-label="Clear all filters and search"
            >
              Clear
            </button>
          </div>
          <div className="overflow-x-auto rounded shadow bg-white">
            <table className="table">
              <thead>
                <tr>
                  {FIELDS.map(f => (
                    <th key={f.key} className="px-2 py-2 border-b text-left font-semibold cursor-pointer select-none" onClick={() => setSort(s => ({ key: f.key, dir: s.key === f.key && s.dir === 'asc' ? 'desc' : 'asc' }))}>
                      <Tooltip text={f.tooltip}>
                        <span>{f.label}{f.required && <span className="text-red-500">*</span>}</span>
                        {sort.key === f.key && (sort.dir === 'asc' ? ' ↑' : ' ↓')}
                      </Tooltip>
                    </th>
                  ))}
                  <th className="px-2 py-2 border-b">Actions</th>
                </tr>
              </thead>
              <tbody
                ref={tableBodyRef}
                className={filteredData.length > VIRTUAL_LIMIT ? 'scrollbar-thin' : ''}
                style={filteredData.length > VIRTUAL_LIMIT ? { height: `${VIRTUAL_LIMIT * rowHeight}px`, overflowY: 'auto', display: 'block' } : {}}
                onScroll={e => setScrollTop(e.target.scrollTop)}
              >
                {visibleRows.map((row, idx) => (
                  <tr
                    key={row._id}
                    tabIndex={0}
                    className="hover:bg-[#e4ede9] cursor-pointer group"
                    onClick={e => {
                      // Prevent row click if action button is clicked
                      if (e.target.closest('.action-icon-btn')) return;
                      handleViewLesson(row);
                    }}
                    onKeyDown={e => {
                      if ((e.key === 'Enter' || e.key === ' ') && !e.target.closest('.action-icon-btn')) {
                        handleViewLesson(row);
                      }
                    }}
                  >
                    {FIELDS.map(f => (
                      <td
                        key={f.key}
                        className={`px-2 py-2 border-b ${f.required && !row[f.key] ? 'border-red-500' : ''} ${quickEdit.id === row._id && quickEdit.field === f.key ? 'bg-yellow-100' : ''}`}
                        tabIndex={0}
                        aria-label={`${f.label}: ${row[f.key]}`}
                        onDoubleClick={() => handleQuickEdit(row._id, f.key)}
                        style={f.key === 'Status' ? { minWidth: '120px' } : {}}
                      >
                        {quickEdit.id === row._id && quickEdit.field === f.key ? (
                          <input
                            type={f.type === 'date' ? 'date' : 'text'}
                            className="px-1 py-0.5 border rounded w-full"
                            value={row[f.key] || ''}
                            autoFocus
                            onBlur={e => handleQuickEditSave(row._id, f.key, e.target.value)}
                            onKeyDown={e => { if (e.key === 'Enter') handleQuickEditSave(row._id, f.key, e.target.value); if (e.key === 'Escape') setQuickEdit({ id: null, field: null }); }}
                          />
                        ) : f.key === 'Status' ? <span className={`status-badge status-${row[f.key]?.toLowerCase().replace(/\s/g, '-')}`}>{row[f.key]}</span>
                          : f.key === 'Impact Level' ? <ImpactBadge level={row[f.key]} />
                          : f.key === 'Timeline' ? formatDate(row[f.key])
                          : row[f.key]
                        }
                      </td>
                    ))}
                    <td className="px-2 py-2 border-b">
                      <div className="flex items-center justify-start gap-2 action-icons">
                        <button className="action-icon-btn action-icon-edit" onClick={() => handleEdit(row._id)} aria-label="Edit" title="Edit">
                          <svg width="20" height="20" fill="none" viewBox="0 0 20 20"><path d="M4 13.5V16h2.5l7.06-7.06-2.5-2.5L4 13.5zM15.41 7.09a1 1 0 000-1.41l-1.09-1.09a1 1 0 00-1.41 0l-1.13 1.13 2.5 2.5 1.13-1.13z" fill="currentColor"/></svg>
                        </button>
                        <button className="action-icon-btn action-icon-delete" onClick={() => handleDelete(row._id)} aria-label="Delete" title="Delete">
                          <svg width="20" height="20" fill="none" viewBox="0 0 20 20"><path d="M6 7v7a1 1 0 001 1h6a1 1 0 001-1V7M4 7h12M9 7V5a1 1 0 011-1h0a1 1 0 011 1v2" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/></svg>
                        </button>
                        <button className="action-icon-btn action-icon-duplicate" onClick={() => handleDuplicate(row._id)} aria-label="Duplicate" title="Duplicate">
                          <svg width="20" height="20" fill="none" viewBox="0 0 20 20"><rect x="7" y="7" width="7" height="7" rx="2" fill="currentColor"/><rect x="4" y="4" width="7" height="7" rx="2" stroke="currentColor" strokeWidth="1.5"/></svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
                {visibleRows.length === 0 && (
                  <tr><td colSpan={FIELDS.length + 1} className="text-center py-4">No data found.</td></tr>
                )}
              </tbody>
            </table>
          </div>
          {/* Add/Edit Form */}
          {(Object.keys(editRow).length > 0) && (
            <div className="fixed inset-0 z-50 bg-black bg-opacity-30 flex items-center justify-center">
              <div className="modal-card" role="dialog" aria-modal="true" aria-labelledby="edit-lesson-title">
                <button className="modal-close" onClick={handleCancel} aria-label="Close">&times;</button>
                <h2 id="edit-lesson-title">{editingId ? 'Edit Lesson' : 'Add Lesson'}</h2>
                <form onSubmit={e => { e.preventDefault(); handleSave(); }}>
                  {FIELDS.map(f => (
                    <div className="form-group" key={f.key}>
                      <label className="form-label" htmlFor={f.key}>
                        {f.label} {f.required && <span className="required">*</span>}
                      </label>
                      {f.type === 'select' ? (
                        <select
                          className="input"
                          id={f.key}
                          value={editRow[f.key] || ''}
                          onChange={e => setEditRow(er => ({ ...er, [f.key]: e.target.value }))}
                          required={f.required}
                          aria-invalid={f.required && !editRow[f.key]}
                        >
                          <option value="">Select {f.label}</option>
                          {f.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                        </select>
                      ) : f.type === 'date' ? (
                        <input
                          type="date"
                          className="input"
                          id={f.key}
                          value={editRow[f.key] || ''}
                          onChange={e => setEditRow(er => ({ ...er, [f.key]: e.target.value }))}
                        />
                      ) : f.autoComplete ? (
                        <AutoCompleteInput
                          value={editRow[f.key] || ''}
                          options={autoCompleteOptions[f.key] || []}
                          onChange={val => setEditRow(er => ({ ...er, [f.key]: val }))}
                          required={f.required}
                        />
                      ) : (
                        <textarea
                          id={f.key}
                          name={f.key}
                          className="modal-input"
                          value={editRow[f.key] || ''}
                          onChange={e => setEditRow(er => ({ ...er, [f.key]: e.target.value }))}
                          required={f.required}
                          rows={3}
                          style={{resize: 'vertical'}}
                        />
                      )}
                      {f.required && !editRow[f.key] && <div className="error-message">{f.label} is required.</div>}
                    </div>
                  ))}
                  <div className="button-row">
                    <button type="button" className="btn-modal-cancel" onClick={handleCancel}>Cancel</button>
                    <button type="submit" className="btn-modal-save">Save</button>
                  </div>
                </form>
              </div>
            </div>
          )}
          <ConfirmModal open={confirm.open} onConfirm={() => { confirm.action(); setConfirm({ open: false, action: null, message: '' }); }} onCancel={() => setConfirm({ open: false, action: null, message: '' })} message={confirm.message} />
          {showDashboard && <Dashboard data={data} onClose={() => setShowDashboard(false)} />}
          {viewLesson && (
            <div className="modal-overlay" tabIndex={-1} onClick={closeViewLesson}>
              <div className="view-modal-card" style={{pointerEvents: 'auto'}} onClick={e => e.stopPropagation()}>
                <button className="view-modal-close" onClick={closeViewLesson} aria-label="Close">&times;</button>
                <div className="view-modal-title">Lesson Details</div>
                <div className="flex flex-col gap-3">
                  {FIELDS.filter(f => f.key !== 'Tags').map(f => (
                    <div key={f.key}>
                      <div className="view-modal-label">{f.label}</div>
                      <div className="view-modal-value">
                        {f.key === 'Impact Level' ? <ImpactBadge level={viewLesson[f.key]} /> : (viewLesson[f.key] || <span className="text-gray-400">—</span>)}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // --- Render App ---
    ReactDOM.createRoot(document.getElementById('root')).render(<LessonsLearnedApp />);
  </script>
</body>
</html> 
